#!/usr/bin/env bash
# Interactive setup for SimpleScalar cache experiment configuration.
# This script rewrites config/ss_cache.sh with your chosen settings.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${SCRIPT_DIR}/.."
SS_CACHE_FILE="${PROJECT_ROOT}/config/ss_cache.sh"

echo "=== SimpleScalar Cache Experiment Setup ==="

# -------------------------------
# Prompt helpers
# -------------------------------
prompt_default() {
  local prompt="$1"
  local default="$2"
  local var
  read -r -p "${prompt} [${default}]: " var
  if [[ -z "${var}" ]]; then
    echo "${default}"
  else
    echo "${var}"
  fi
}

# -------------------------------
# Collect settings
# -------------------------------

# Cache geometry (you can accept defaults)
IL1_CFG=$(prompt_default "L1 instruction cache config" "il1:32768:64:1:l")
DL1_CFG=$(prompt_default "L1 data cache config"        "dl1:32768:64:1:l")
UL2_CFG=$(prompt_default "Unified L2 cache config"     "ul2:262144:64:4:l")

# Experiment mode
echo
echo "Experiment mode options:"
echo "  baseline       - no victim/miss cache, no stream buffers"
echo "  victim         - victim cache enabled on DL1"
echo "  miss           - miss cache enabled on DL1"
echo "  stream         - stream buffers enabled"
echo "  victim_stream  - victim cache + stream buffers"
MODE_DEFAULT="baseline"
SS_MODE_CHOICE=$(prompt_default "Experiment mode" "${MODE_DEFAULT}")

# Victim cache size
VC_ENTRIES=$(prompt_default "Victim cache entries (DL1) [only used in victim/victim_stream]" "4")

# Miss cache size
MC_ENTRIES=$(prompt_default "Miss cache entries (DL1) [only used in miss]" "4")

# Stream buffer settings
SB_COUNT=$(prompt_default "Stream buffer count [only used in stream/victim_stream]" "1")
SB_DEPTH=$(prompt_default "Stream buffer depth (lines per buffer)" "4")
SB_DEGREE=$(prompt_default "Stream buffer degree (lines prefetched per trigger)" "1")

echo
echo "Writing configuration to: ${SS_CACHE_FILE}"
echo

# -------------------------------
# Generate config/ss_cache.sh
# -------------------------------
cat > "${SS_CACHE_FILE}" <<EOF
# Auto-generated by scripts/setup_cache_experiment.sh
# SimpleScalar cache and experiment configuration

########################################
# Base cache geometry
########################################

# L1 instruction cache
export SS_IL1_CONFIG="${IL1_CFG}"

# L1 data cache
export SS_DL1_CONFIG="${DL1_CFG}"

# Unified L2 cache
export SS_UL2_CONFIG="${UL2_CFG}"

########################################
# Experiment mode (single knob)
########################################
# Valid values (for your own bookkeeping / stats):
#   baseline
#   victim
#   miss
#   stream
#   victim_stream

: "\${SS_MODE:=${SS_MODE_CHOICE}}"
export SS_MODE

########################################
# Base parameters (sizes, not enables)
########################################

# Victim cache parameters
: "\${SS_VC_ENTRIES:=${VC_ENTRIES}}"

# Miss cache parameters
: "\${SS_MC_ENTRIES:=${MC_ENTRIES}}"

# Stream buffer parameters
: "\${SS_SB_COUNT:=${SB_COUNT}}"
: "\${SS_SB_DEPTH:=${SB_DEPTH}}"
: "\${SS_SB_DEGREE:=${SB_DEGREE}}"

export SS_VC_ENTRIES
export SS_MC_ENTRIES
export SS_SB_COUNT
export SS_SB_DEPTH
export SS_SB_DEGREE

########################################
# Derived enables based on SS_MODE
########################################
# We do not set enables manually elsewhere â€“ they are implied by SS_MODE.

case "\${SS_MODE}" in
  baseline)
    export SS_VC_ENABLE=0
    export SS_MC_ENABLE=0
    export SS_SB_ENABLE=0
    ;;

  victim)
    export SS_VC_ENABLE=1   # victim cache on DL1
    export SS_MC_ENABLE=0
    export SS_SB_ENABLE=0
    ;;

  miss)
    export SS_VC_ENABLE=0
    export SS_MC_ENABLE=1   # miss cache on DL1
    export SS_SB_ENABLE=0
    ;;

  stream)
    export SS_VC_ENABLE=0
    export SS_MC_ENABLE=0
    export SS_SB_ENABLE=1   # stream buffers only
    ;;

  victim_stream)
    export SS_VC_ENABLE=1   # victim + stream
    export SS_MC_ENABLE=0
    export SS_SB_ENABLE=1
    ;;

  *)
    echo "WARNING: unknown SS_MODE='\${SS_MODE}', falling back to baseline" >&2
    export SS_VC_ENABLE=0
    export SS_MC_ENABLE=0
    export SS_SB_ENABLE=0
    ;;
esac
EOF

echo "Done."
echo
echo "Summary:"
echo "  SS_IL1_CONFIG = ${IL1_CFG}"
echo "  SS_DL1_CONFIG = ${DL1_CFG}"
echo "  SS_UL2_CONFIG = ${UL2_CFG}"
echo "  SS_MODE       = ${SS_MODE_CHOICE}"
echo "  SS_VC_ENTRIES = ${VC_ENTRIES}"
echo "  SS_MC_ENTRIES = ${MC_ENTRIES}"
echo "  SS_SB_COUNT   = ${SB_COUNT}"
echo "  SS_SB_DEPTH   = ${SB_DEPTH}"
echo "  SS_SB_DEGREE  = ${SB_DEGREE}"
echo
echo "Next time you run env.sh / run_all scripts, they will pick up this config."
